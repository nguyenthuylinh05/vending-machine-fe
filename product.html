<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý sản phẩm nước</title>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: #f0f4f8;
        margin: 0;
        padding: 30px;
      }
      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }
      .product-container {
        max-width: 950px;
        margin: auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        padding: 20px 30px;
      }
      .product-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }
      .product-header button {
        padding: 10px 15px;
        background: linear-gradient(90deg, #ff512f, #dd2476);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
      }
      .product-header button:hover {
        background: #d32f2f;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
        vertical-align: middle;
      }
      th {
        background-color: #d32f2f;
        color: white;
      }
      tr:hover {
        background-color: #f5f5f5;
      }
      .btn {
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        color: white;
      }
      .btn-edit {
        background: linear-gradient(90deg, #ff512f, #dd2476);
      }
      .btn-delete {
        background: #f44336;
      }
      .btn-edit:hover {
        background: #1976d2;
      }
      .btn-delete:hover {
        background: #d32f2f;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background: white;
        padding: 25px;
        border-radius: 10px;
        width: 400px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        animation: pop 0.3s ease;
      }
      @keyframes pop {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      .modal-content h2 {
        margin-top: 0;
        color: #333;
        text-align: center;
      }
      .modal-content label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
      }
      .modal-content input {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .modal-buttons {
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
      }
      .modal-buttons button {
        flex: 1;
        margin: 0 5px;
        padding: 8px;
        border: none;
        border-radius: 6px;
        color: white;
        cursor: pointer;
      }
      .btn-save {
        background: #d32f2f;
      }
      .btn-cancel {
        background: #888;
      }
      .btn-save:hover {
        background: #d32f2f;
      }
      .btn-cancel:hover {
        background: #666;
      }
    </style>
  </head>
  <body>
    <h1>Quản lý sản phẩm nước</h1>

    <div class="product-container">
      <div class="product-header">
        <h3>Danh sách sản phẩm</h3>
        <button id="btnAdd">+ Thêm sản phẩm</button>
      </div>

      <table id="productTable">
        <thead>
          <tr>
            <th>Mã SP</th>
            <th>Tên sản phẩm</th>
            <th>Giá (₫)</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody>
          <!-- Render từ API -->
        </tbody>
      </table>
    </div>

    <!-- Modal (KHÔNG có trường mã SP) -->
    <div class="modal" id="modal">
      <div class="modal-content">
        <h2 id="modalTitle">Thêm sản phẩm</h2>

        <label for="productName">Tên nước</label>
        <input type="text" id="productName" placeholder="Nhập tên nước" />

        <label for="productPrice">Giá (₫)</label>
        <input type="number" id="productPrice" placeholder="Nhập giá" min="0" />

        <div class="modal-buttons">
          <button class="btn-save" id="saveBtn">Lưu</button>
          <button class="btn-cancel" id="cancelBtn">Hủy</button>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:5000/api/products";

      let products = []; // Danh sách từ API
      let editingId = null; // _id của record đang sửa

      const tableBody = document.querySelector("#productTable tbody");
      const modal = document.querySelector("#modal");
      const modalTitle = document.querySelector("#modalTitle");
      const nameInput = document.querySelector("#productName");
      const priceInput = document.querySelector("#productPrice");
      const btnAdd = document.querySelector("#btnAdd");
      const btnSave = document.querySelector("#saveBtn");
      const btnCancel = document.querySelector("#cancelBtn");

      function authHeaders() {
        const token = sessionStorage.getItem("token");
        return token ? { Authorization: `Bearer ${token}` } : {};
      }

      async function httpGetAll() {
        const res = await fetch(API_BASE, { headers: { ...authHeaders() } });
        if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
        const json = await res.json();
        return json?.metadata?.products ?? [];
      }

      async function httpCreate(payload) {
        const res = await fetch(API_BASE, {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
        return res.json();
      }

      async function httpUpdate(id, payload) {
        const res = await fetch(`${API_BASE}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
        return res.json();
      }

      async function httpDelete(id) {
        const res = await fetch(`${API_BASE}/${id}`, {
          method: "DELETE",
          headers: { ...authHeaders() },
        });
        if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
        return res.json();
      }

      function vnd(n) {
        const num = Number(n) || 0;
        return new Intl.NumberFormat("vi-VN").format(num);
      }

      function renderTable() {
        tableBody.innerHTML = products
          .map(
            (p) => `
        <tr>
          <td>${p.product_id ?? ""}</td>
          <td>${p.name ?? ""}</td>
          <td>${vnd(p.price)}</td>
          <td>
            <button class="btn btn-edit" onclick="editProduct('${
              p._id
            }')">Sửa</button>
            <button class="btn btn-delete" onclick="deleteProduct('${
              p._id
            }')">Xóa</button>
          </td>
        </tr>
      `
          )
          .join("");
      }

      function openModal(isEdit = false) {
        modal.style.display = "flex";
        modalTitle.textContent = isEdit
          ? "Chỉnh sửa sản phẩm"
          : "Thêm sản phẩm";
        setTimeout(() => nameInput.focus(), 50);
      }

      function closeModal() {
        modal.style.display = "none";
        nameInput.value = "";
        priceInput.value = "";
        editingId = null;
      }

      btnAdd.onclick = () => openModal(false);
      btnCancel.onclick = closeModal;

      btnSave.onclick = async () => {
        const name = (nameInput.value || "").trim();
        const price = Number(priceInput.value);

        if (!name || !Number.isFinite(price) || price <= 0) {
          alert("Vui lòng nhập tên và giá hợp lệ!");
          return;
        }

        try {
          if (editingId) {
            // KHÔNG cho phép sửa product_id
            await httpUpdate(editingId, { name, price });
          } else {
            // Tạo mới: KHÔNG gửi product_id (backend tự increment)
            await httpCreate({ name, price });
          }
          await loadData();
          closeModal();
        } catch (err) {
          console.error(err);
          alert("Lỗi khi lưu sản phẩm: " + err.message);
        }
      };

      window.editProduct = (id) => {
        const p = products.find((x) => x._id === id);
        if (!p) return;
        editingId = id;
        nameInput.value = p.name ?? "";
        priceInput.value = p.price ?? 0;
        openModal(true);
      };

      window.deleteProduct = async (id) => {
        if (!confirm("Bạn có chắc chắn muốn xóa sản phẩm này?")) return;
        try {
          await httpDelete(id);
          await loadData();
        } catch (err) {
          console.error(err);
          alert("Lỗi khi xóa sản phẩm: " + err.message);
        }
      };

      async function loadData() {
        try {
          products = await httpGetAll();
          renderTable();
        } catch (err) {
          console.error(err);
          alert("Không tải được danh sách sản phẩm: " + err.message);
        }
      }

      window.onclick = (e) => {
        if (e.target === modal) closeModal();
      };

      // Khởi động
      loadData();
    </script>
  </body>
</html>
